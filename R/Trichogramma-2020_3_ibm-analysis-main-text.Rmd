---
title: 'Trichogramma range expansions (genetics and dynamics): 3- individual-based model, analysis (main text)'
author: "Maxime Dahirel"
date: "31/03/2020"
output: 
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options: 
  chunk_output_type: console
---


```{r}
library(arm)
library(tidyverse)
library(here)

library(modelr)
library(RColorBrewer)

###inference
library(coda)
library(rstan)
library(bayesplot)
library(brms)
rstan_options(auto_write = TRUE)
options(mc.cores = 2)
library(tidybayes)
library(cowplot)
library(patchwork)
```

# TO DO 

- check priors for parameters that have been multiplied by *X* to make them fit within "general priors" (and all the others)
- find a valid colour code (reminder: need 6 different colours, a subgroup of 4 for treatment plots and a subgroup of 2 for front/core plots, ideally qualitative scales, colourblind- and BW-friendly at least within each subgroup)
- markdown comments?
- clean and tidy code, re-arrange order of lines in ggplot code
- check all loaded packages are still actually useful
-remove the restricted +DDD from the main text model
- do the genetics model as a logit student here too??
- tidying up model control params (iter, chains, delta...)
- choose colors that are colorblind AND greyscale friendly (the front/core ones are currently NOT)

```{r importing-data}
data <- read_csv(file=here("NetLogo_output/model-output.csv"))
```

# data wrangling

## genetics

```{r}
#ggplot(data) +geom_line(aes(x=ticks,y=Hexp,group=replicateID,col=treatment))+facet_wrap(~treatment+is.front+K)
###lots of zero, can't use

####method variance in fraction (gandhi 2019 pnas). works by "averaging across" replicates, no zeros in dataset
#### simplifies problems caused in Hexp when there are zeros (beta, logit transformations can't do anything)

data_genetics <- data %>% 
  group_by(ticks,treatment,is.front,K) %>% 
  summarise(varP1=var(P1),varP0=var(P0)) %>% 
  mutate(K=factor(K))

#ggplot(data_genetics)+
#  geom_line(aes(x=ticks,y=varP1,col=treatment))+
#  facet_wrap(~is.front+K)
```

## front location

```{r}
data_front <- data %>% 
  filter(is.front == TRUE) %>% 
  mutate(front=pxcor) %>% 
  mutate(K=factor(K))

#ggplot(data_front)+
#  geom_line(aes(x=ticks,y=front,group=replicateID))+
#  facet_wrap(~treatment+K)+
#  geom_abline(aes(intercept=0,slope=(3/(2*sqrt(2)))*velocity_fisher),col="red")+
#  geom_abline(aes(intercept=0,slope=velocity_fisher),col="blue")
```

# models

## genetics

```{r}
prior_genetics=c(
  set_prior("normal(0.25,1.5)",nlpar=c("logitVmax")), #informative prior
  set_prior("normal(0,1)",nlpar=c("logdecay"),class="b"),
  set_prior("normal(0,1)",nlpar="invphi",lb=0)
)

bf_genetics <- bf(varP1~logit(Vmax*(1-exp(-(ticks)*decay))),
                  nlf(Vmax~inv_logit(logitHasym)),
                  nlf(decay~10^(logdecay)),
                  logitVmax~1,
                  logdecay~0+treatment:is.front:K,
                  nlf(phi~1/invphi),
                  invphi~1,
                  family=Beta(link_phi="identity"),nl=TRUE)

mod_genetics=brm(bf_genetics,
                 data=data_genetics,
                 iter=2000,chains=4,
                 prior=prior_genetics
)
```


```{r}
prior_front <- c(
  #set_prior("normal(0,1)",nlpar="logitspeedstart",class="b"),
  set_prior("normal(0,1)",nlpar="logitspeedasym",class="b"),
  set_prior("normal(0,1)",nlpar="lograte",class="b"),
  set_prior("normal(0,1)",nlpar="logitspeedasym",class="sd"),
  set_prior("normal(0,1)",nlpar="lograte",class="sd"),
  set_prior("normal(0,1)",class="sigma"),
  set_prior("lkj(2)",class="cor")
)



bf_front <- bf(front~log(speed*ticks),
               nlf(speed~speedasym+(1-speedasym)*exp(-(ticks-1)*rate)), ##speedstart forced to 1
               nlf(rate~10^(lograte)),
               nlf(speedasym~inv_logit(logitspeedasym)),
               #nlf(speedstart~exp(logitspeedstart)),
               logitspeedasym~0+treatment:factor(K)+(1|1|replicateID),
               #logitspeedstart~0+treatment+(1|1|replicateID),
               lograte~0+treatment:factor(K)+(1|1|replicateID),
               family=lognormal,nl=TRUE)

mod_front=brm(bf_front,
              data=subset(data_front,ticks>0),chains=4,iter=200,
              prior=prior_front,control=list(adapt_delta=0.8,max_treedepth=10))
```


# plots

```{r color-palettes, eval=FALSE}

TRTpalette <- c("#F0E442","#009E73", "#F0E442","#CC79A7") # a 4 color palette so it can also be used for simulation results
frontcorePalette <- c("#000000", "#E69F00", "#56B4E9") # 3 colors, for origin (black), front and core patches

```


## genetics

```{r}
## not shown in main text: 
data_genetics %>% ungroup() %>% 
  select(treatment,is.front,K) %>% 
  distinct() %>% 
  expand_grid(ticks=(1:100)) %>% 
  add_fitted_draws(mod_genetics,re_formula = NA) %>% 
  group_by(ticks, treatment) %>% 
  ggplot()+
  geom_line(data=data_genetics,aes(x=ticks, y=varP1,col=treatment))+
  stat_lineribbon(aes(x=ticks,y=.value),.width=0.95,alpha=0.25)+
  scale_y_continuous("Variance in fraction")+
  facet_grid(cols=vars(treatment),rows=vars(is.front,K))+
  theme_half_open(11)+
  background_grid(colour.major = "grey95",colour.minor = "grey95")



data_genetics %>% ungroup() %>% 
  mutate(treatment = fct_relevel(treatment, "reduced + DDD", after = Inf)) %>% 
  #filter(treatment != "reduced + DDD") %>% 
  select(treatment,is.front,K) %>% 
  mutate(Location=factor(is.front)) %>% 
  mutate(Location=fct_recode(Location,front="TRUE",core="FALSE")) %>% 
  mutate(Location=fct_relevel(Location,"front","core")) %>% 
  distinct() %>% 
  mutate(ticks=1) %>% 
  add_fitted_draws(mod_genetics,re_formula = NA,nlpar="logdecay") %>% 
  mutate(.value=10^(.value)) %>% 
  ggplot()+
  stat_eye(aes(x=K,fill=Location,group=Location,y=.value),position="dodge",normalize="xy")+
  facet_grid(cols=vars(treatment),rows=vars(Location),scales="free_y")+
  scale_y_continuous(name=expression(paste("genetic diversity decay rate  ",lambda)))+
  scale_x_discrete("equilibrium population size K")+
  scale_fill_manual("Location",values=c("#E69F00","#56B4E9"))+
  #scale_colour_manual("Location",values=c("#E69F00","#56B4E9"))+
  theme_half_open(11)+
  background_grid(colour.major = "grey95",colour.minor = "grey95")

#alternate theme, needs cowplot and ggtext to work
#    theme_half_open(12) +
#    background_grid() +
#    theme(
#        strip.background = element_blank(),
#        strip.text = element_textbox(
#            size = 12,
#            color = "black", fill = "grey90", box.color = "grey",
#            halign = 0.5, r = unit(0, "pt"), width = unit(1, "npc"),height = unit(36, "pt"),
#            padding = margin(2, 2, 2, 2), margin = margin(3, 3, 3, 3)
#        )
#    )
```

## front

```{r}

thresholds <- data_front %>% 
  mutate(threshold_pushed=(3/(2*sqrt(2)))*velocity_fisher) %>% 
  select(K,treatment,velocity_fisher,threshold_pushed) %>% 
  distinct() %>% 
  pivot_longer(cols=c(velocity_fisher,threshold_pushed),
               values_to = "threshold_value",names_to = "threshold_type") %>% 
  mutate(threshold_type=fct_recode(threshold_type,vF="velocity_fisher",
                                   `3/(2 x sqrt(2))) x vF`="threshold_pushed")) %>% 
  mutate(treatment = fct_relevel(treatment, "reduced + DDD", after = Inf))

#not shown 
data_front%>% 
  ungroup() %>% 
  mutate(replicateID= unique(replicateID)[1]) %>% 
  select(treatment,replicateID,K) %>% 
  distinct() %>% 
  expand_grid(ticks=(1:100)) %>% 
  add_fitted_draws(mod_front,re_formula=NA) %>% 
  group_by(ticks, treatment) %>% 
  ggplot()+
  geom_line(data=data_front,aes(x=ticks, y=front,group=replicateID),col="grey",alpha=0.2)+
  stat_lineribbon(aes(x=ticks,y=.value),.width=0.95,alpha=0.5)+
  scale_y_continuous("Front location (patches from release)")+
  scale_x_continuous("time (generations)")+
  facet_grid(cols=vars(treatment),rows=vars(paste("K = ",K,sep="")),space= "free_x",scale="free_x")+
  geom_abline(data=thresholds,aes(intercept=0,slope=threshold_value,col=threshold_type),lty=2)

data_front %>%
  mutate(treatment = fct_relevel(treatment, "reduced + DDD", after = Inf)) %>% 
  #filter(treatment != "reduced + DDD") %>% 
  ungroup() %>% 
  mutate(replicateID= replicateID[1],ticks=1) %>% 
  select(treatment,ticks,replicateID,K) %>% 
  distinct() %>%
  add_fitted_draws(mod_front,nlpar="logitspeedasym",re_formula=NA) %>% 
  mutate(.value=invlogit(.value)) %>% 
  ggplot()+
  geom_hline(data=thresholds,aes(yintercept = threshold_value,lty=threshold_type))+
  stat_eye(aes(x=factor(K),group=K,y=.value),normalize="xy")+
  scale_y_continuous("Asymptotic velocity (posterior)") +
  scale_x_discrete("equilibrium population size K")+
  scale_linetype_discrete(name="",
                       labels=c(
                         expression(paste(frac(3,2*sqrt(2)), "  ", italic(v[F]))),
                         expression(italic(v[F])))
                       )+
  facet_grid(cols=vars(treatment))+
  theme_half_open(11)+
  background_grid(colour.major = "grey95",colour.minor = "grey95")+
  theme(legend.title=element_blank(),legend.position = c(0.86, 0.3),legend.background = element_rect(fill = "white",colour = "black"),legend.margin=margin(t=2,r=2,l=2,b=2))

data_front %>% 
  ungroup() %>% 
  mutate(replicateID= replicateID[1],ticks=1) %>% 
  select(treatment,ticks,replicateID,K) %>% 
  distinct() %>%
  add_fitted_draws(mod_front,nlpar="logitspeedasym",re_formula=NA) %>%
  mutate(.value=invlogit(.value))%>% 
  mutate(.value=.value/velocity_fisher) %>% 
  mean_hdi()
```

